- name: Add grafana repository key
  apt_key:
    id: 8C8C34C524098CB6
    url: https://packages.grafana.com/gpg.key

- name: Add grafana repository
  apt_repository:
    repo: "deb https://packages.grafana.com/oss/deb stable main"

- name: Install grafana
  apt:
    name: grafana
  notify: restart grafana

- name: Install plugins
  command: grafana-cli plugins install grafana-piechart-panel

- name: Configurate grafana
  template:
    src: grafana.ini.j2
    dest: /etc/grafana/grafana.ini
  notify: restart grafana

- name: Create dashboard folders
  file:
    path: /etc/grafana/dashboards
    state: directory
    mode: 0750
    owner: root
    group: grafana

- name: Provisioning
  template:
    src: "{{ item }}.j2"
    dest: "/etc/grafana/provisioning/{{ item }}"
    mode: 0640
    owner: root
    group: grafana
  with_items:
  - dashboards/ffbs.yaml
  - datasources/ffbs.yaml
  notify: restart grafana

- name: Install dashboards
  copy:
    src: "{{ item }}"
    dest: "/etc/grafana/dashboards/{{ item }}"
    mode: 0640
    owner: root
    group: grafana
  with_items:
  - global.json
  - node.json

- name: Enable grafana
  service:
    name: grafana-server
    state: started
    enabled: yes

- name: Configure nginx location
  template:
    src: nginx-location.conf.j2
    dest: /etc/nginx/site-default.d/50-grafana.conf
